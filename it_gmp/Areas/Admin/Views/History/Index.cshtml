@{
    ViewData["Title"] = "History";
    Layout = "~/Views/Shared/_Admin.cshtml";
}

<div class="row clearfix">
    <div class="col-12">
        <section class="card card-fluid">
            <div class="card-header drag-handle d-flex">
                <div>
                    <span>Hiện cột:</span>
                    <select class="chosen toggle-vis" multiple style="width:500px;">
                        <option value="0" selected>Stt</option>
                        <option value="1" selected>Người thay đổi</option>
                        <option value="2" selected>Ngày thay đổi</option>
                        <option value="3" selected>Loại</option>
                        <option value="4" selected>Mô tả</option>
                        <option value="5">Bảng</option>
                        <option value="6">Key</option>
                        <option value="7">Giá trị cũ</option>
                        <option value="8">Giá trị mới</option>
                    </select>
                </div>
                <div class="ml-auto">
                    <button class='export btn btn-sm btn-success'>Xuất Excel</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="quanlytin" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
                        <thead>
                            <tr>
                                <th>Stt</th>
                                <th>Người thay đổi</th>
                                <th>Ngày thay đổi</th>
                                <th>
                                    Loại
                                    <div class="dropdown d-inline-block float-right">
                                        <a class="dropdown-toggle" id="drop3" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
                                            <i class="fas fa-filter"></i>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="drop3">
                                            <div class="p-3">
                                                <input class="form-control form-control-sm" id="filter_type" />
                                                <div class="mt-2 text-center">
                                                    <button class="mr-1 btn btn-sm btn-danger clear_type">
                                                        Xóa
                                                    </button>
                                                    <button class="btn btn-sm btn-primary apply">
                                                        Áp dụng
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    Mô tả
                                    <div class="dropdown d-inline-block float-right">
                                        <a class="dropdown-toggle" id="drop4" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
                                            <i class="fas fa-filter"></i>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="drop4" style="width:400px">
                                            <div class="p-3">
                                                <input class="form-control form-control-sm" id="filter_description" />
                                                <div class="mt-2 text-center">
                                                    <button class="mr-1 btn btn-sm btn-danger clear_description">
                                                        Xóa
                                                    </button>
                                                    <button class="btn btn-sm btn-primary apply">
                                                        Áp dụng
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th>Bảng</th>
                                <th>Key</th>
                                <th>Giá trị cũ</th>
                                <th>Giá trị mới</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>
</div>

@section Scripts{

    <script type='text/javascript'>
        $(document).ready(function () {
            $(".export").click(async function () {
                $(".preloader").show();
                var search_date = $(".search_date").val();
                let filter_type = $("#filter_type").val();
                let filter_description = $("#filter_description").val();
                let da = await $.ajax({
                    "url": "/admin/history/exportexcel",
                    "data": { search_date: search_date, filter_type: filter_type, filter_description: filter_description },
                    "type": "POST",
                    "dataType": "JSON"
                })
                $(".preloader").hide();
                location.href = da.url;
            })
            let table = $('#quanlytin').DataTable({
                "stateSave": true,
                "processing": true,
                "serverSide": true,
                // "ordering": false,
                "ajax": {
                    "url": "/admin/history/table",
                    "dataType": "json",
                    "type": "POST",
                    'data': function (data) {
                        let search_date = $(".search_date").val();
                        let filter_type = $("#filter_type").val();
                        let filter_description = $("#filter_description").val();
                        data['search_date'] = search_date;
                        data['filter_type'] = filter_type;
                        data['filter_description'] = filter_description;
                    }
                },
                initComplete: function () {
                    $(".dataTables_filter label input").addClass("d-none");
                    $(".dataTables_filter label").append("<input style='margin-left: 0.5em;display: inline-block;width: 500px;' class='form-control form-control-sm search_date' />");

                    $(".search_date").daterangepicker({
                        autoApply: true,
                        autoUpdateInput: false,
                        maxDate: new Date(),
                        locale: {
                            format: 'DD/MM/YYYY'
                        }
                    }).on("apply.daterangepicker", function (e, picker) {
                        picker.element.val(picker.startDate.format(picker.locale.format) + " - " + picker.endDate.format(picker.locale.format));
                        table.ajax.reload();
                    });
                },
                "columns": [{
                    "data": "id",
                    "orderable": false
                }, {
                    "data": "user",
                    "orderable": false
                },
                {
                    "data": "datetime",
                    "orderable": false
                }, {
                    "data": "type",
                    "orderable": false
                },
                {
                    "data": "description",
                    "orderable": false
                },
                {
                    "data": "tableName",
                    "orderable": false
                }, {
                    "data": "primaryKey",
                    "orderable": false
                },
                {
                    "data": "oldValues",
                    "orderable": false
                },
                {
                    "data": "newValues",
                    "orderable": false
                }
                ],
            });

            $(".apply").click(function () {
                table.ajax.reload();
            });

            $(".clear_type").click(function () {
                $("#filter_type").val("");
                table.ajax.reload();
            });

            $(".clear_description").click(function () {
                $("#filter_description").val("");
                table.ajax.reload();
            });
            $('.toggle-vis').on('change', function (e) {
                // Get the column API object
                var value = $(this).val()
                if (!value)
                    return;
                var columns = table.columns();
                columns.visible(false);
                for (var val of value) {
                    var column = table.column(val);
                    // Toggle the visibility
                    column.visible(true);
                }
            });
            $('.toggle-vis').trigger("change");
        });
    </script>
}